name: Deploy to GitHub Pages

on:
  name: Deploy to GitHub Pages

  on:
    push:
      branches: [ main ]

  jobs:
    deploy:
      runs-on: ubuntu-latest
      permissions:
        contents: read
        actions: read
        pages: write
        id-token: write

      steps:
        - name: Checkout code
          uses: actions/checkout@v4

        - name: Setup Pages
          uses: actions/configure-pages@v4

        - name: Prepare site folder
          run: |
            rm -rf site || true
            mkdir -p site
            cp -r index.html site/
            if [ -d assets ]; then cp -r assets site/; fi

        - name: Upload artifact
          uses: actions/upload-pages-artifact@v3
          with:
            path: 'site'

        - name: Verify uploaded artifact exists
          run: |
            echo "Checking artifacts for run: $GITHUB_RUN_ID"
            resp=$(curl -s -H "Authorization: Bearer $GITHUB_TOKEN" -H "Accept: application/vnd.github+json" "https://api.github.com/repos/${{ github.repository }}/actions/runs/${GITHUB_RUN_ID}/artifacts")
            echo "$resp" | sed -n '1,200p'
            total=$(echo "$resp" | grep -o '"total_count"[[:space:]]*:[[:space:]]*[0-9]\+' | grep -o '[0-9]\+')
            if [ -z "$total" ] || [ "$total" -eq 0 ]; then
              echo "ERROR: no artifacts found for run $GITHUB_RUN_ID. Upload may have failed."
              exit 1
            fi

        - name: Debug: show run id and list artifacts
          run: |
            echo "GITHUB_RUN_ID=$GITHUB_RUN_ID"
            echo "Listing artifacts for this run via REST API..."
            curl -s -H "Authorization: Bearer $GITHUB_TOKEN" -H "Accept: application/vnd.github+json" "https://api.github.com/repos/${{ github.repository }}/actions/runs/${GITHUB_RUN_ID}/artifacts" | jq || true

        - name: Deploy to GitHub Pages
          id: deployment
          uses: actions/deploy-pages@v2
              run: |

                echo "GITHUB_RUN_ID=$GITHUB_RUN_ID"

                echo "Listing artifacts for this run via REST API..."
